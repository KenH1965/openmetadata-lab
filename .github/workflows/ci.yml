name: CI

on:
  push:
    branches: [ main, master, feat/**, feature/** ]
  pull_request:
    branches: [ main, master, feat/**, feature/** ]
  workflow_dispatch:

jobs:
  validate-yaml-k8s:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install lint tools
        run: |
          python -m pip install --upgrade pip
          pip install yamllint
          curl -L -o kubeconform.tar.gz https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz
          tar -xzf kubeconform.tar.gz
          sudo mv kubeconform /usr/local/bin/kubeconform
      - name: YAML lint
        run: yamllint -d '{extends: default, rules: {line-length: {max: 160}}}' .
      - name: Kubernetes schema validation
        if: ${{ hashFiles('config/k8s/**.y*ml') != '' }}
        run: kubeconform -ignore-missing-schemas -summary -verbose config/k8s

  python-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: openmetadata-data-consumer-setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run pytest
        run: pytest -q
      - name: Summary
        if: always()
        run: |
          echo "Python: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "Tests finished" >> $GITHUB_STEP_SUMMARY

  scripts-import-check:
    runs-on: ubuntu-latest
    needs: python-tests
    defaults:
      run:
        working-directory: openmetadata-data-consumer-setup
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install deps
        run: pip install -r requirements.txt
      - name: Import scripts
        run: |
          python - <<'EOF'
          import importlib, pathlib, sys
          mods = [p.stem for p in pathlib.Path('src/scripts').glob('*.py')]
          failures = []
          for m in mods:
              try:
                  importlib.import_module(f'src.scripts.{m}')
              except Exception as e:
                  failures.append((m, e))
          if failures:
              for m,e in failures:
                  print(f'FAILED {m}: {e}', file=sys.stderr)
              sys.exit(1)
          print('All script imports OK')
          EOF

  # NOTE: Integration tests requiring OM_URL/OM_TOKEN can be added as a separate job with encrypted secrets.
